import streamlit as st
import subprocess
import shutil
import re
from pathlib import Path

# ==================================================
# Streamlit UI
# ==================================================
st.set_page_config(layout="wide")
st.title("Steel System Optimization (AMPL)")
st.caption("Edit parameters → Run AMPL → View results")

# ==================================================
# Paths
# ==================================================
BASE_DIR = Path(__file__).parent

PARAM_FILE = BASE_DIR / "parameters.mod"
USER_PARAM_FILE = BASE_DIR / "user_parameters.mod"
RUN_FILE = BASE_DIR / "run_ampl.run"

REQUIRED_FILES = [
    "parameters.mod",
    "main.mod",
    "variables.mod",
    "cost_report.mod",
    "emissions_report.mod",
    "report.mod",
]

# ==================================================
# Sanity checks
# ==================================================
missing = [f for f in REQUIRED_FILES if not (BASE_DIR / f).exists()]
if missing:
    st.error(f"Missing required AMPL files: {', '.join(missing)}")
    st.stop()

AMPL_EXE = shutil.which("ampl")
if not AMPL_EXE:
    st.error("AMPL executable not found in PATH")
    st.stop()

# ==================================================
# Load scalar DEFAULT parameters
# ==================================================
param_pattern = re.compile(
    r"^\s*param\s+(\w+)\s+default\s+([-+0-9.eE]+)\s*;",
    re.IGNORECASE,
)

params = {}

with open(PARAM_FILE) as f:
    for line in f:
        m = param_pattern.match(line)
        if m:
            params[m.group(1)] = float(m.group(2))

if not params:
    st.error(
        "No scalar DEFAULT parameters found.\n\n"
        "Use this format in parameters.mod:\n\n"
        "param x default 10;"
    )
    st.stop()

# ==================================================
# Sidebar: parameter editor
# ==================================================
st.sidebar.header("Model Parameters")

user_params = {
    k: st.sidebar.number_input(k, value=v, format="%.6f")
    for k, v in sorted(params.items())
}

# ==================================================
# Write user override file
# ==================================================
def write_user_parameters(p):
    with open(USER_PARAM_FILE, "w") as f:
        f.write("# Auto-generated by Streamlit\n\n")
        for k, v in p.items():
            f.write(f"let {k} := {v};\n")

# ==================================================
# Write AMPL run file (ALWAYS overwrite)
# ==================================================
def write_run_file():
    with open(RUN_FILE, "w") as f:
        f.write(
            "reset;\n\n"
            "include parameters.mod;\n"
            "include user_parameters.mod;\n"
            "include main.mod;\n\n"
            "include variables.mod;\n"
            "solve;\n\n"
            'printf "\\n=== AMPL SOLVE COMPLETED ===\\n";\n\n'
            "include cost_report.mod;\n"
            "include emissions_report.mod;\n"
            "include report.mod;\n"
        )

# ==================================================
# Run AMPL
# ==================================================
if st.button("Run Optimization", type="primary"):

    write_user_parameters(user_params)
    write_run_file()

    with st.spinner("Running AMPL..."):
        result = subprocess.run(
            [AMPL_EXE, str(RUN_FILE)],
            cwd=BASE_DIR,
            capture_output=True,
            text=True,
        )

    if result.returncode != 0:
        st.error("AMPL execution failed")
        st.subheader("STDERR")
        st.text(result.stderr)
        st.stop()

    st.success("Optimization completed")

    output = (result.stdout or "") + "\n" + (result.stderr or "")
    output = output.strip()

    st.subheader("AMPL Output")

    if not output:
        st.error(
            "AMPL ran successfully but produced NO OUTPUT.\n\n"
            "This means:\n"
            "• solve; did not run\n"
            "• or reports were not executed\n"
            "• or printf statements were removed\n"
        )
    else:
        st.text(output)
