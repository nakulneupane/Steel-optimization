import streamlit as st
import subprocess
import shutil
import re
from pathlib import Path
import pandas as pd

# ==================================================
# Streamlit setup
# ==================================================
st.set_page_config(layout="wide")
st.title("Steel System Optimization (AMPL)")
st.caption("Edit parameters → Run AMPL → View results")

# ==================================================
# Paths
# ==================================================
BASE_DIR = Path(__file__).parent
PARAM_FILE = BASE_DIR / "parameters.mod"
USER_PARAM_FILE = BASE_DIR / "user_parameters.mod"
RUN_FILE = BASE_DIR / "run_ampl.run"
AMPL_OUTPUT_FILE = BASE_DIR / "ampl_output.txt"

# ==================================================
# Sanity checks
# ==================================================
if not PARAM_FILE.exists():
    st.error("Missing parameters.mod")
    st.stop()

AMPL_EXE = shutil.which("ampl")
if not AMPL_EXE:
    st.error("AMPL executable not found in PATH")
    st.stop()

# ==================================================
# Load DEFAULT scalar parameters
# ==================================================
param_pattern = re.compile(
    r"^\s*param\s+(\w+)\s+default\s+([0-9.eE+-]+)\s*;",
    re.IGNORECASE
)

def load_defaults():
    params = {}
    with open(PARAM_FILE) as f:
        for line in f:
            m = param_pattern.match(line)
            if m:
                params[m.group(1)] = float(m.group(2))
    return params

params = load_defaults()
if not params:
    st.error("No parameters declared as `param x default v;`")
    st.stop()

# ==================================================
# Sidebar parameters
# ==================================================
st.sidebar.header("Model Parameters")
user_params = {
    k: st.sidebar.number_input(k, value=v, format="%.6f")
    for k, v in sorted(params.items())
}

# ==================================================
# Write override file
# ==================================================
def write_user_parameters(p):
    with open(USER_PARAM_FILE, "w") as f:
        f.write("# Auto-generated by Streamlit\n")
        for k, v in p.items():
            f.write(f"let {k} := {v};\n")

# ==================================================
# Write AMPL run file
# ==================================================
def write_run_file():
    with open(RUN_FILE, "w") as f:
        f.write(f"""
reset;
option log_file "{AMPL_OUTPUT_FILE.name}";
option log_flush 1;

include parameters.mod;
include user_parameters.mod;
include main.mod;
""")

# ==================================================
# Run AMPL
# ==================================================
if st.button("Run Optimization", type="primary"):

    write_user_parameters(user_params)
    write_run_file()

    with st.spinner("Running AMPL..."):
        subprocess.run([AMPL_EXE, RUN_FILE.name], cwd=BASE_DIR)

    if not AMPL_OUTPUT_FILE.exists():
        st.error("AMPL produced no output.")
        st.stop()

    st.success("Optimization completed")

    text = AMPL_OUTPUT_FILE.read_text(encoding="utf-8", errors="ignore")

    # ==================================================
    # PARSE COST REPORT
    # ==================================================
    cost_rows = []
    current_year = None

    for line in text.splitlines():
        if "Year" in line and "----" in line:
            current_year = int(re.findall(r"\d{4}", line)[0])

        if "BF-BOF steel:" in line:
            bf = float(re.findall(r"\$ *([\d.]+)", line)[0])
        if "Coal DRI–EAF steel:" in line:
            coal = float(re.findall(r"\$ *([\d.]+)", line)[0])
        if "NG DRI–EAF steel:" in line:
            ng = float(re.findall(r"\$ *([\d.]+)", line)[0])
        if "Scrap–EAF steel:" in line:
            scrap = float(re.findall(r"\$ *([\d.]+)", line)[0])
        if "Average Cost:" in line:
            avg = float(re.findall(r"\$ *([\d.]+)", line)[0])

            cost_rows.append({
                "Year": current_year,
                "BF-BOF ($/t)": bf,
                "Coal DRI ($/t)": coal,
                "NG DRI ($/t)": ng,
                "Scrap ($/t)": scrap,
                "Average ($/t)": avg
            })

    cost_df = pd.DataFrame(cost_rows)

    # ==================================================
    # PARSE EMISSIONS REPORT
    # ==================================================
    emis_rows = []
    current_year = None
    scope1 = scope2 = total = None

    for line in text.splitlines():
        if "Year" in line and "----" in line:
            current_year = int(re.findall(r"\d{4}", line)[0])

        if "Average Scope-1 Emissions:" in line:
            scope1 = float(re.findall(r"([\d.]+)", line)[0])
        if "Average Scope-2 Emissions:" in line:
            scope2 = float(re.findall(r"([\d.]+)", line)[0])
        if "Average System Emissions:" in line:
            total = float(re.findall(r"([\d.]+)", line)[0])

            emis_rows.append({
                "Year": current_year,
                "Avg Scope-1 (tCO₂/t)": scope1,
                "Avg Scope-2 (tCO₂/t)": scope2,
                "Avg Total (tCO₂/t)": total
            })

    emis_df = pd.DataFrame(emis_rows)

    # ==================================================
    # Results viewer
    # ==================================================
    st.divider()
    view = st.selectbox(
        "Select result to display",
        [
            "Cost per ton of steel",
            "CO₂ emissions per ton of steel"
        ]
    )

    if view == "Cost per ton of steel":
        st.subheader("Cost per ton of steel (2025–2050)")
        st.dataframe(
            cost_df.style
            .background_gradient(cmap="Blues", subset=cost_df.columns[1:])
            .format("{:.2f}"),
            use_container_width=True
        )

    elif view == "CO₂ emissions per ton of steel":
        st.subheader("CO₂ emissions per ton of steel (2025–2050)")
        st.dataframe(
            emis_df.style
            .background_gradient(cmap="Reds", subset=emis_df.columns[1:])
            .format("{:.3f}"),
            use_container_width=True
        )
