import streamlit as st
import subprocess
import shutil
import re
import pandas as pd
import numpy as np
from pathlib import Path

# ==================================================
# Streamlit setup
# ==================================================
st.set_page_config(layout="wide")
st.title("Steel System Optimization (AMPL)")
st.caption("Edit parameters ‚Üí Run AMPL ‚Üí View results")

# ==================================================
# Paths
# ==================================================
BASE_DIR = Path(__file__).parent
PARAM_FILE = BASE_DIR / "parameters.mod"
USER_PARAM_FILE = BASE_DIR / "user_parameters.mod"
RUN_FILE = BASE_DIR / "run_ampl.run"
AMPL_OUTPUT_FILE = BASE_DIR / "ampl_output.txt"

# ==================================================
# Sanity checks
# ==================================================
if not PARAM_FILE.exists():
    st.error("Missing parameters.mod")
    st.stop()

AMPL_EXE = shutil.which("ampl")
if not AMPL_EXE:
    st.error("AMPL executable not found in PATH")
    st.stop()

# ==================================================
# Load DEFAULT scalar parameters
# ==================================================
param_pattern = re.compile(
    r"^\s*param\s+(\w+)\s+default\s+([0-9.eE+-]+)\s*;",
    re.IGNORECASE
)

def load_defaults():
    params = {}
    with open(PARAM_FILE) as f:
        for line in f:
            m = param_pattern.match(line)
            if m:
                params[m.group(1)] = float(m.group(2))
    return params

params = load_defaults()
if not params:
    st.error("No parameters declared as `param x default v;`")
    st.stop()

# ==================================================
# Sidebar controls
# ==================================================
st.sidebar.header("Model Parameters")
user_params = {
    k: st.sidebar.number_input(k, value=v, format="%.6f")
    for k, v in sorted(params.items())
}

# ==================================================
# Write override file
# ==================================================
def write_user_parameters(p):
    with open(USER_PARAM_FILE, "w") as f:
        f.write("# Auto-generated by Streamlit\n")
        for k, v in p.items():
            f.write(f"let {k} := {v};\n")

# ==================================================
# Write AMPL run file
# ==================================================
def write_run_file():
    with open(RUN_FILE, "w") as f:
        f.write(f"""
reset;
option log_file "{AMPL_OUTPUT_FILE.name}";
option log_flush 1;

include parameters.mod;
include user_parameters.mod;
include main.mod;
""")

# ==================================================
# Run AMPL
# ==================================================
if st.button("Run Optimization", type="primary"):

    write_user_parameters(user_params)
    write_run_file()

    with st.spinner("Running AMPL..."):
        subprocess.run([AMPL_EXE, RUN_FILE.name], cwd=BASE_DIR)

    if not AMPL_OUTPUT_FILE.exists():
        st.error("AMPL ran but produced no output.")
        st.stop()

    st.success("Optimization completed")

    lines = AMPL_OUTPUT_FILE.read_text(
        encoding="utf-8",
        errors="ignore"
    ).splitlines()

    # ==================================================
    # 1) COST PER TON (KEEP WORKING LOGIC)
    # ==================================================
    cost_rows = []
    year = None
    bf = coal = ng = h2 = scrap = avg = np.nan

    for l in lines:
        if "Year" in l and "----" in l:
            if year is not None:
                cost_rows.append({
                    "Year": year,
                    "BF-BOF ($/t)": bf,
                    "Coal DRI-EAF ($/t)": coal,
                    "NG DRI-EAF ($/t)": ng,
                    "H‚ÇÇ DRI-EAF ($/t)": h2,
                    "Scrap-EAF ($/t)": scrap,
                    "Average ($/t)": avg,
                })
            year = int(re.findall(r"\d{4}", l)[0])
            bf = coal = ng = h2 = scrap = avg = np.nan

        if "BF-BOF steel:" in l:
            bf = float(re.findall(r"([\d.]+)", l)[0])
        elif "Coal DRI‚ÄìEAF steel:" in l:
            coal = float(re.findall(r"([\d.]+)", l)[0])
        elif "NG DRI‚ÄìEAF steel:" in l:
            ng = float(re.findall(r"([\d.]+)", l)[0])
        elif "H2 DRI‚ÄìEAF steel:" in l:
            h2 = float(re.findall(r"([\d.]+)", l)[0])
        elif "Scrap‚ÄìEAF steel:" in l:
            scrap = float(re.findall(r"([\d.]+)", l)[0])
        elif "Average Cost:" in l:
            avg = float(re.findall(r"([\d.]+)", l)[0])

    if year is not None:
        cost_rows.append({
            "Year": year,
            "BF-BOF ($/t)": bf,
            "Coal DRI-EAF ($/t)": coal,
            "NG DRI-EAF ($/t)": ng,
            "H‚ÇÇ DRI-EAF ($/t)": h2,
            "Scrap-EAF ($/t)": scrap,
            "Average ($/t)": avg,
        })

    df_cost = pd.DataFrame(cost_rows)
    st.subheader("üí∞ Cost per ton of steel")
    st.dataframe(df_cost, use_container_width=True)

    # ==================================================
    # 2) EMISSIONS PER TON (TOTAL ONLY)
    # ==================================================
    emis_rows = []
    year = None
    bf = coal = ng = h2 = scrap = avg = np.nan

    for l in lines:
        if "Year" in l and "----" in l:
            if year is not None:
                emis_rows.append({
                    "Year": year,
                    "BF-BOF": bf,
                    "Coal DRI-EAF": coal,
                    "NG DRI-EAF": ng,
                    "H‚ÇÇ DRI-EAF": h2,
                    "Scrap-EAF": scrap,
                    "Average": avg,
                })
            year = int(re.findall(r"\d{4}", l)[0])
            bf = coal = ng = h2 = scrap = avg = np.nan

        if "BF-BOF Total per ton:" in l:
            bf = float(re.findall(r"([\d.]+)", l)[0])
        elif "Coal DRI-EAF Total per ton:" in l:
            coal = float(re.findall(r"([\d.]+)", l)[0])
        elif "NG DRI-EAF Total per ton:" in l:
            ng = float(re.findall(r"([\d.]+)", l)[0])
        elif "H2 DRI-EAF Total per ton:" in l:
            h2 = float(re.findall(r"([\d.]+)", l)[0])
        elif "Scrap-EAF Total per ton:" in l:
            scrap = float(re.findall(r"([\d.]+)", l)[0])
        elif "Average System Emissions:" in l:
            avg = float(re.findall(r"([\d.]+)", l)[0])

    if year is not None:
        emis_rows.append({
            "Year": year,
            "BF-BOF": bf,
            "Coal DRI-EAF": coal,
            "NG DRI-EAF": ng,
            "H‚ÇÇ DRI-EAF": h2,
            "Scrap-EAF": scrap,
            "Average": avg,
        })

    df_emis = pd.DataFrame(emis_rows)
    st.subheader("üåç CO‚ÇÇ emissions per ton of steel")
    st.dataframe(df_emis, use_container_width=True)

    # ==================================================
    # 3) PRODUCTION ROUTES (12 columns)
    # ==================================================
    prod_rows = []
    prod_re = re.compile(
        r"^\s*(\d{4})\s+"
        r"(\d+)/\s*([\d.]+)\s+"
        r"(\d+)/\s*([\d.]+)\s+"
        r"(\d+)/\s*([\d.]+)\s+"
        r"(\d+)/\s*([\d.]+)\s+"
        r"(\d+)/\s*([\d.]+)\s+"
        r"(\d+)"
    )

    for l in lines:
        m = prod_re.match(l)
        if m:
            prod_rows.append({
                "Year": int(m.group(1)),
                "BF-BOF (t)": float(m.group(2)),
                "BF-BOF frac": float(m.group(3)),
                "Coal DRI (t)": float(m.group(4)),
                "Coal DRI frac": float(m.group(5)),
                "NG DRI (t)": float(m.group(6)),
                "NG DRI frac": float(m.group(7)),
                "H‚ÇÇ DRI (t)": float(m.group(8)),
                "H‚ÇÇ DRI frac": float(m.group(9)),
                "Scrap-EAF (t)": float(m.group(10)),
                "Scrap-EAF frac": float(m.group(11)),
                "Total steel (t)": float(m.group(12)),
            })

    df_prod = pd.DataFrame(prod_rows)
    st.subheader("üè≠ Production routes")
    st.dataframe(df_prod, use_container_width=True)

    # ==================================================
    # 4) CARBON CAPTURE (8 columns)
    # ==================================================
    ccs_rows = []
    ccs_re = re.compile(
        r"^\s*(\d{4})\s+"
        r"(\d+)/\s*([\d.]+)\s+"
        r"(\d+)/\s*([\d.]+)\s+"
        r"(\d+)/\s*([\d.]+)\s+"
        r"(\d+)"
    )

    for l in lines:
        m = ccs_re.match(l)
        if m:
            ccs_rows.append({
                "Year": int(m.group(1)),
                "BF-BOF CCS (t)": float(m.group(2)),
                "BF-BOF CCS frac": float(m.group(3)),
                "Coal DRI CCS (t)": float(m.group(4)),
                "Coal DRI CCS frac": float(m.group(5)),
                "NG DRI CCS (t)": float(m.group(6)),
                "NG DRI CCS frac": float(m.group(7)),
                "Total CCS (t)": float(m.group(8)),
            })

    df_ccs = pd.DataFrame(ccs_rows)
    st.subheader("üß™ Carbon capture requirements")
    st.dataframe(df_ccs, use_container_width=True)
