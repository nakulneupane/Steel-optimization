import streamlit as st
import subprocess
import re
from pathlib import Path
import shutil
import pandas as pd

# ==================================================
# Streamlit setup
# ==================================================
st.set_page_config(layout="wide")
st.title("Steel System Optimization (AMPL)")
st.caption("Edit parameters → Run AMPL → View results")

# ==================================================
# Paths
# ==================================================
BASE_DIR = Path(__file__).parent
MAIN_MOD_FILE = BASE_DIR / "main.mod"
PARAM_FILE = BASE_DIR / "parameters.mod"
USER_PARAM_FILE = BASE_DIR / "user_parameters.mod"
RUN_FILE = BASE_DIR / "run_ampl.run"
COST_REPORT = BASE_DIR / "cost_report.mod"
EMISSIONS_REPORT = BASE_DIR / "emissions_report.mod"
GENERAL_REPORT = BASE_DIR / "report.mod"

# ==================================================
# Sanity checks
# ==================================================
missing = [f.name for f in [PARAM_FILE, MAIN_MOD_FILE] if not f.exists()]
if missing:
    st.error(f"Missing required files: {', '.join(missing)}")
    st.stop()

# ==================================================
# Detect AMPL executable
# ==================================================
AMPL_EXE = shutil.which("ampl")
if not AMPL_EXE:
    st.error("AMPL executable not found in PATH. Please install AMPL or add it to PATH.")
    st.stop()

# ==================================================
# Extract scalar parameters (default) from parameters.mod
# ==================================================
param_pattern = re.compile(
    r"^\s*param\s+(\w+)\s+default\s+([0-9.eE+-]+)\s*;",
    re.IGNORECASE
)

def load_parameters():
    params = {}
    with open(PARAM_FILE, "r") as f:
        for line in f:
            match = param_pattern.match(line)
            if match:
                name, value = match.groups()
                params[name] = float(value)
    return params

params = load_parameters()
if not params:
    st.error("No scalar parameters found in parameters.mod")
    st.stop()

# ==================================================
# Sidebar: parameter editor
# ==================================================
st.sidebar.header("Model Parameters")
user_params = {}
for name, value in sorted(params.items()):
    user_params[name] = st.sidebar.number_input(
        label=name,
        value=value,
        format="%.6f"
    )

# ==================================================
# Write user parameter file
# ==================================================
def write_user_parameters(params_dict):
    with open(USER_PARAM_FILE, "w") as f:
        f.write("# Auto-generated by Streamlit\n\n")
        for k, v in params_dict.items():
            f.write(f"let {k} := {v};\n")

# ==================================================
# Create run_ampl.run if missing
# ==================================================
if not RUN_FILE.exists():
    with open(RUN_FILE, "w") as f:
        f.write(
            "# Auto-generated run file for Streamlit\n"
            "include parameters.mod;\n"
            "include user_parameters.mod;\n"
            "include main.mod;\n"
        )

# ==================================================
# Function to parse AMPL-style report files
# ==================================================
def parse_ampl_report(file_path):
    """Parse AMPL [*] style file to pandas Series"""
    if not file_path.exists():
        return pd.Series(dtype=float)
    text = file_path.read_text()
    tokens = text.split()
    years = [int(tokens[i]) for i in range(0, len(tokens), 2)]
    values = [float(tokens[i]) for i in range(1, len(tokens), 2)]
    return pd.Series(data=values, index=years)

# ==================================================
# Run AMPL
# ==================================================
if st.button("Run Optimization", type="primary"):
    write_user_parameters(user_params)
    
    with st.spinner("Running AMPL optimization..."):
        result = subprocess.run(
            [AMPL_EXE, str(RUN_FILE)],
            cwd=BASE_DIR,
            capture_output=True,
            text=True
        )
    
    st.subheader("AMPL Output")
    st.text("=== STDOUT ===")
    st.text(result.stdout)
    st.text("=== STDERR ===")
    st.text(result.stderr)

    if result.returncode != 0:
        st.error("AMPL execution failed. Check the STDERR above for details.")
    else:
        st.success("Optimization completed successfully")

        # --------------------------
        # Read and display reports
        # --------------------------
        cost = parse_ampl_report(COST_REPORT)
        emissions = parse_ampl_report(EMISSIONS_REPORT)
        steel = parse_ampl_report(GENERAL_REPORT)

        if not cost.empty:
            st.subheader("Total Cost ($)")
            st.line_chart(cost)

        if not emissions.empty:
            st.subheader("Total Emissions (ton CO2)")
            st.line_chart(emissions)

        if not steel.empty:
            st.subheader("Total Steel Production (tons)")
            st.line_chart(steel)
